name: Build & Deploy DEV (Kustomize)

on:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'deploy/**'
      - '.github/workflows/build-deploy-dev.yml'
  workflow_dispatch:
    inputs:
      overlay_path:
        description: "Kustomize overlay path for DEV"
        required: true
        default: "deploy/overlays/dev"
      deployment_name:
        description: "K8s Deployment name"
        required: true
        default: "myapp"
      namespace:
        description: "K8s namespace"
        required: true
        default: "sample-app"        

permissions:
  contents: read

env:
  IMAGE_REPO_PREFIX: "apps"   # image path = apps/<repo>

jobs:
  dev:
    runs-on: ubuntu-latest
    outputs:
      image_ref: ${{ steps.vars.outputs.image_ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive image repo & tag
        id: vars
        shell: bash
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          IMAGE_REPO="${IMAGE_REPO_PREFIX}/${REPO_NAME}"
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE_TAG="sha-${SHORT_SHA}"
          IMAGE_FQDN="${{ secrets.ACR_NAME }}.azurecr.io"
          IMAGE_REF="${IMAGE_FQDN}/${IMAGE_REPO}:${IMAGE_TAG}"
          echo "repo=${IMAGE_REPO}"       >> $GITHUB_OUTPUT
          echo "tag=${IMAGE_TAG}"         >> $GITHUB_OUTPUT
          echo "image_fqdn=${IMAGE_FQDN}" >> $GITHUB_OUTPUT
          echo "image_ref=${IMAGE_REF}"   >> $GITHUB_OUTPUT
          echo "Computed image: ${IMAGE_REF}"

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        run: az acr login -n ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---- Unit tests: replace with your stack ----
      - name: Unit tests (placeholder)
        run: echo "Run mvn/gradle/npm/pytest here"
      # --------------------------------------------

      - name: Build & Push image to ACR
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.vars.outputs.image_ref }}
            ${{ steps.vars.outputs.image_fqdn }}/${{ steps.vars.outputs.repo }}:latest
          cache-from: type=registry,ref=${{ steps.vars.outputs.image_fqdn }}/${{ steps.vars.outputs.repo }}:buildcache
          cache-to: type=registry,ref=${{ steps.vars.outputs.image_fqdn }}/${{ steps.vars.outputs.repo }}:buildcache,mode=max

      - name: Trivy scan (critical/high â†’ fail)
        uses: aquasecurity/trivy-action@0.22.0
        with:
            image-ref: ${{ steps.vars.outputs.image_ref }}
            format: 'table'
            exit-code: '1'
            severity: 'CRITICAL,HIGH'

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kustomize
        env:
          KUSTOMIZE_VERSION: v5.4.1
        run: |
          set -euo pipefail
          curl -sSL -o kustomize.tar.gz \
            "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar -xzf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin/kustomize
          kustomize version

      - name: Get AKS credentials (DEV)
        run: |
          az aks get-credentials \
            -g "${{ secrets.AKS_RG_DEV }}" \
            -n "${{ secrets.AKS_CLUSTER_DEV }}" \
            --overwrite-existing

      - name: Ensure namespace exists
        run: kubectl create namespace ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Update image in DEV overlay
        working-directory: ${{ inputs.overlay_path }}
        run: |
          kustomize edit set image \
            ${{ steps.vars.outputs.image_fqdn }}/${{ steps.vars.outputs.repo }}=${{ steps.vars.outputs.image_ref }}

      - name: Deploy to DEV (Kustomize)
        run: kubectl apply -k ${{ inputs.overlay_path }}

      - name: Wait for rollout (DEV)
        run: kubectl -n ${{ inputs.namespace }} rollout status deployment/${{ inputs.deployment_name }} --timeout=180s

      - name: Show pods (DEV)
        run: kubectl -n ${{ inputs.namespace }} get pods -o wide

      - name: Save image_ref for promotion
        run: echo '${{ steps.vars.outputs.image_ref }}' > image_ref.txt

      - name: Upload image_ref artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-ref
          path: image_ref.txt